# Event Count Discrepancy - Fix Documentation

## Problem Diagram

### BEFORE (Incorrect - causes discrepancy)

```
┌─────────────────────────────────────────────────────────────┐
│ Deploy Workflow (6 AM UTC or 10:30 PM UTC)                  │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  1. Build JS bundles                                         │
│  2. Configure AWS credentials                                │
│  3. Generate static site (make all → freeze.py)              │
│     ├─ Reads S3: upcoming-history/metadata.json              │
│     └─ Sees: 8 events for 2026-02-06                         │
│     └─ Generates: build/just-added/index.html ✗ (8 events)  │
│  4. Sync to S3                                               │
│  5. Invalidate CloudFront                                    │
│  6. Track events (track_events.py)                           │
│     ├─ Compares current vs previous upcoming.yaml           │
│     ├─ Finds: 11 new events for 2026-02-06                  │
│     └─ Updates S3: metadata.json ✓ (11 events)              │
│                                                              │
└─────────────────────────────────────────────────────────────┘

Later at 11 PM UTC:
┌─────────────────────────────────────────────────────────────┐
│ Daily Summary Workflow                                       │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  1. post_daily_event_summary.py                              │
│     ├─ Reads S3: upcoming-history/metadata.json              │
│     ├─ Sees: 11 events for 2026-02-06 ✓                     │
│     └─ Posts: "11 new events added today: ..."              │
│                                                              │
└─────────────────────────────────────────────────────────────┘

RESULT: Website shows 8, post says 11 ❌
```

### AFTER (Correct - consistent counts)

```
┌─────────────────────────────────────────────────────────────┐
│ Deploy Workflow (6 AM UTC or 10:30 PM UTC)                  │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  1. Build JS bundles                                         │
│  2. Configure AWS credentials                                │
│  3. Track events (track_events.py)  ← MOVED HERE             │
│     ├─ Compares current vs previous upcoming.yaml           │
│     ├─ Finds: 11 new events for 2026-02-06                  │
│     └─ Updates S3: metadata.json ✓ (11 events)              │
│  4. Generate static site (make all → freeze.py)              │
│     ├─ Reads S3: upcoming-history/metadata.json              │
│     ├─ Sees: 11 events for 2026-02-06 ✓                     │
│     └─ Generates: build/just-added/index.html ✓ (11 events) │
│  5. Sync to S3                                               │
│  6. Invalidate CloudFront                                    │
│                                                              │
└─────────────────────────────────────────────────────────────┘

Later at 11 PM UTC:
┌─────────────────────────────────────────────────────────────┐
│ Daily Summary Workflow                                       │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  1. post_daily_event_summary.py                              │
│     ├─ Reads S3: upcoming-history/metadata.json              │
│     ├─ Sees: 11 events for 2026-02-06 ✓                     │
│     └─ Posts: "11 new events added today: ..."              │
│                                                              │
└─────────────────────────────────────────────────────────────┘

RESULT: Website shows 11, post says 11 ✅
```

## Key Insight

The `/just-added/` page is a **static HTML file** generated by `freeze.py`. Once frozen, it cannot dynamically update. Therefore, we must ensure `track_events.py` updates the S3 metadata **before** `freeze.py` reads it.

## Files Changed

1. `.github/workflows/deploy.yml` - Reordered steps
2. `test_workflow_order.py` - New test file to prevent regression
3. `EVENT_TRACKING.md` - Updated documentation

## Testing

The new test ensures this order is maintained:

```python
def test_track_events_runs_before_freeze():
    """Verify 'Track events' comes before 'Generate static site'"""
    # Loads deploy.yml and checks step indices
    assert track_events_index < generate_site_index
```

This test will fail if anyone accidentally reorders the steps in the future.
