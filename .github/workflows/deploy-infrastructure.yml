name: Deploy Infrastructure

on:
  push:
    branches:
      - main
    paths:
      - 'infrastructure/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy-cdk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Install CDK dependencies
        working-directory: infrastructure
        run: npm ci

      - name: CDK Bootstrap (if needed)
        working-directory: infrastructure
        run: npx cdk bootstrap

      - name: CDK Synth
        working-directory: infrastructure
        run: npx cdk synth

      - name: CDK Deploy
        working-directory: infrastructure
        run: npx cdk deploy --require-approval never --outputs-file outputs.json

      - name: Display CDK Outputs
        working-directory: infrastructure
        run: |
          if [ -f outputs.json ]; then
            echo "CDK Stack Outputs:"
            cat outputs.json
          fi

      - name: Extract CloudFront Distribution ID
        id: extract-outputs
        working-directory: infrastructure
        run: |
          if [ -f outputs.json ]; then
            DISTRIBUTION_ID=$(cat outputs.json | jq -r '.LocalTechStack.DistributionId // empty')
            S3_BUCKET=$(cat outputs.json | jq -r '.LocalTechStack.BucketName // empty')

            if [ -n "$DISTRIBUTION_ID" ]; then
              echo "CloudFront Distribution ID: $DISTRIBUTION_ID"
              echo "distribution_id=$DISTRIBUTION_ID" >> $GITHUB_OUTPUT
            fi

            if [ -n "$S3_BUCKET" ]; then
              echo "S3 Bucket Name: $S3_BUCKET"
              echo "s3_bucket=$S3_BUCKET" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Update Repository Secrets
        if: steps.extract-outputs.outputs.distribution_id != ''
        run: |
          echo "⚠️ Please update the following GitHub Secrets manually:"
          echo "CLOUDFRONT_DISTRIBUTION_ID=${{ steps.extract-outputs.outputs.distribution_id }}"
          echo "S3_BUCKET_NAME=${{ steps.extract-outputs.outputs.s3_bucket }}"
          echo ""
          echo "Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
