name: Post Daily Event Summary to Micro.blog

on:
  # Run daily at 11 PM UTC (6 PM ET / 7 PM EDT)
  schedule:
    - cron: '0 23 * * *'
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Test without posting (dry run)'
        required: false
        type: boolean
        default: false
      date:
        description: 'Check for events added on specific date (YYYY-MM-DD). Default: today'
        required: false
        type: string

# Permissions for OIDC federation with AWS (to read from S3)
permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: us-east-1
  S3_BUCKET: ${{ vars.S3_BUCKET }}
  AWS_ROLE_ARN: ${{ vars.AWS_ROLE_ARN }}

jobs:
  post-daily-summary:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install boto3 requests pytz pyyaml

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: github-actions-event-summary
          role-duration-seconds: 900

      - name: Post daily event summary to micro.blog
        env:
          MB_TOKEN: ${{ secrets.MB_TOKEN }}
          MICROBLOG_DESTINATION: ${{ vars.MICROBLOG_DESTINATION }}
        run: |
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            if [ -n "${{ github.event.inputs.date }}" ]; then
              python post_daily_event_summary.py --dry-run --date "${{ github.event.inputs.date }}"
            else
              python post_daily_event_summary.py --dry-run
            fi
          else
            if [ -n "${{ github.event.inputs.date }}" ]; then
              python post_daily_event_summary.py --date "${{ github.event.inputs.date }}"
            else
              python post_daily_event_summary.py
            fi
          fi
